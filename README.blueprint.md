# Ansibler

Generate JSON data that describes the dependencies of an Ansible playbook/role. Also, automatically generate OS compatibility charts using Molecule.

## Table of Contents

- [Installation](#installation)
- [Usage](#usage)

## Requirements
- [Python 3.6+](https://www.python.org/downloads/)

## Installation

You can install Ansibler using pip:

```sh
pip3 install ansibler
```

## Usage

With Ansibler, you can extract both role dependencies and OS compatibility data with the help of [Molecule Tests](https://molecule.readthedocs.io/en/latest/).

<br/>

---
### Generating Compatibility Charts
Say you have run `molecule test` and want to generate updated compatibility charts for your role using the test's output. With Ansibler, it's possible to do just that!

1. Start by dumping the results of your test to `./.molecule-results/YEAR-MONTH-DAY-scenario_tag.txt`. You can do that by running: `PY_COLORS=0 molecule test > .molecule-results/2021-08-07-docker-snap.txt` (make sure to put PY_COLORS=0 at the beginning of the command so the colors are stripped).

2. Then, simply run `ansibler --generate-compatibility-chart` and a new `ansibler.json` will be generated, which will have your brand new compatibility chart under `compatibility_matrix`. It will look something like this:

```
"compatibility_matrix": [
    ["OS Family", "OS Version", "Status", "Idempotent", "Tested On"],
    ["Fedora", "33", "❌", "❌", "April 4th, 2006"],
    ["Ubuntu", "focal", "✅", "❌", "February 5th, 2009"],
    ["Windows", "10", "✅"", "✅"", "January 6th 2020"]
  ],
```

*TIP:* Don't like the `.molecule-results` dir? No problem. You can tell Ansibler to use another directory by passing `--molecule-results-dir` - example:

```ansibler --generate-compatibility-chart --molecule-results-dir molecule/.results```

<br/>

---
### Populating Platforms
You can also update your role's `meta/main.yml` so that `galaxy_info.platforms` matches the new `compatibility_matrix` chart. Simply run the following:
```
ansibler --populate-platforms
```

<br/>

---
### Role Dependency Charts
Finally, you can also add dependency data to your role's `ansibler.json` file. Simply run:

```
ansibler --role-dependencies
```

Ansibler reads your dependencies from `requirements.yml` and then builds an additional depencency chart, which will be added under `role_dependencies` and will look something like the following:

```
{
  "role_dependencies": [
    [
      "Dependency",
      "Description",
      "Supported OSes",
      "Status"
    ],
    [
      "<b><a href=\"https://galaxy.ansible.com/professormanhattan/snapd\" title=\"professormanhattan.snapd on Ansible Galaxy\" target=\"_blank\">professormanhattan.snapd</a></b>",
      "Ensures Snap is installed and properly configured on Linux",
      "<a title=\"Windows 11 build status on GitHub\" href=\"https://gitlab.com/ProfessorManhattan/ansible-snapd/actions/Windows.yml\" target=\"_blank\"><img alt=\"Windows 11 build status\" src=\"https://img.shields.io/github/workflow/status/ProfessorManhattan/ansible-snapd/Windows/master?color=cyan&label=Windows%20build&logo=windows&style=flat\"></a><a title=\"macOS build status on GitHub\" href=\"https://gitlab.com/ProfessorManhattan/ansible-snapd/actions/macOS.yml\" target=\"_blank\"><img alt=\"macOS build status\" src=\"https://img.shields.io/github/workflow/status/ProfessorManhattan/ansible-androidstudio/macOS/master?label=macOS%20build&logo=apple&style=flat\"></a>"
    ],
    [
      "<b><a href=\"https://galaxy.ansible.com/professormanhattan/homebrew\" title=\"professormanhattan.homebrew on Ansible Galaxy\" target=\"_blank\">professormanhattan.homebrew</a></b>",
      "Installs Homebrew on nearly any OS",
      "For simplicity, this cell's data has not been added.",
      "<a title=\"Windows 11 build status on GitHub\" href=\"https://gitlab.com/ProfessorManhattan/ansible-homebrew/actions/Windows.yml\" target=\"_blank\"><img alt=\"Windows 11 build status\" src=\"https://img.shields.io/github/workflow/status/ProfessorManhattan/ansible-homebrew/Windows/master?color=cyan&label=Windows%20build&logo=windows&style=flat\"></a><a title=\"macOS build status on GitHub\" href=\"https://gitlab.com/ProfessorManhattan/ansible-homebrew/actions/macOS.yml\" target=\"_blank\"><img alt=\"macOS build status\" src=\"https://img.shields.io/github/workflow/status/ProfessorManhattan/ansible-androidstudio/macOS/master?label=macOS%20build&logo=apple&style=flat\"></a>"
    ]
  ]
}
```

*NOTE:* the Status column gets generated by reading the `role_dependencies_status_format` field in `./variables.json` and then replacing all ocurrences of `{{ role_name }}` with each dependency name.

*TIP:* You can also run `ansibler --role-dependencies` in your playbooks. Ansibler will attempt to read your roles path (using `ansible-dump`) and generate role dependencies for ALL your roles!

<br>

---
## Additional Info
### Caching
Ansibler generates a cache file under `~/.local/megabytelabs/ansibler` - you can clear it with:
```
ansibler --clear-cache
```

### Overriding ansibler.json and meta/main.yml
By default, Ansibler writes to (and reads from) `ansibler.json`. If you want to override this, add `--json-file` when you use Ansibler. For example:
```
ansibler --generate-compatibility-chart --json-file .example.json
ansibler --populate-platforms --json-file .example.json
ansibler --role-dependencies --json-file .example.json
```

### Help
```
ansibler --help
```
